version: '3.8'

services:
  # ====================================================
  # 1. DATABASE (MySQL)
  # ====================================================
  mysql-db:
    image: mysql:8.0
    container_name: mysql-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: j2ee_project_db
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # ====================================================
  # 2. API GATEWAY (Cổng chính - Public Port)
  # ====================================================
  api-gateway:
    build: ./backend/api_gateway
    container_name: api_gateway
    restart: unless-stopped
    ports:
      - "8888:8888"  # Chỉ mở cổng này cho Backend
    environment:
      - SERVER_PORT=8888
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m
    depends_on:
      mysql-db:
        condition: service_healthy
    networks:
      - app-network

  # ====================================================
  # 3. AUTH SERVICE
  # ====================================================
  auth-service:
    build: ./backend/auth_service
    container_name: auth_service
    restart: unless-stopped
    environment:
      - SERVER_PORT=8080
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/j2ee_project_db?useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root123
    depends_on:
      mysql-db:
        condition: service_healthy
    networks:
      - app-network

  # ====================================================
  # 4. FILE SERVICE
  # ====================================================
  file-service:
    build: ./backend/file_service
    container_name: file_service
    restart: unless-stopped
    environment:
      - SERVER_PORT=8080
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/j2ee_project_db?useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root123
    depends_on:
      mysql-db:
        condition: service_healthy
    networks:
      - app-network

  # ====================================================
  # 5. PRICING SERVICE
  # ====================================================
  pricing-service:
    build: ./backend/pricing_service
    container_name: pricing_service
    restart: unless-stopped
    environment:
      - SERVER_PORT=8080
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/j2ee_project_db?useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root123
    depends_on:
      mysql-db:
        condition: service_healthy
    networks:
      - app-network

  # ====================================================
  # 6. TOUR SERVICE
  # ====================================================
  tour-service:
    build: ./backend/tour_service
    container_name: tour_service
    restart: unless-stopped
    environment:
      - SERVER_PORT=8080
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/j2ee_project_db?useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root123
    depends_on:
      mysql-db:
        condition: service_healthy
    networks:
      - app-network

  # ====================================================
  # 7. BOOKING SERVICE
  # ====================================================
  booking-service:
    build: ./backend/booking_service
    container_name: booking_service
    restart: unless-stopped
    environment:
      - SERVER_PORT=8080
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/j2ee_project_db?useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root123
    depends_on:
      mysql-db:
        condition: service_healthy
    networks:
      - app-network

  # ====================================================
  # 8. INVOICE SERVICE
  # ====================================================
  invoice-service:
    build: ./backend/invoice_service
    container_name: invoice_service
    restart: unless-stopped
    environment:
      - SERVER_PORT=8080
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/j2ee_project_db?useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root123
    depends_on:
      mysql-db:
        condition: service_healthy
    networks:
      - app-network

  # ====================================================
  # 9. SCHEDULE SERVICE
  # ====================================================
  schedule-service:
    build: ./backend/schedule_service
    container_name: schedule_service
    restart: unless-stopped
    environment:
      - SERVER_PORT=8080
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/j2ee_project_db?useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root123
    depends_on:
      mysql-db:
        condition: service_healthy
    networks:
      - app-network

  
  # ====================================================
  # 10. PAYMENT SERVICE
  # ====================================================
  payment-service:
    build: ./backend/payment_service
    container_name: payment_service
    restart: unless-stopped
    environment:
      - SERVER_PORT=8080
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/j2ee_project_db?useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root123
    depends_on:
      mysql-db:
        condition: service_healthy
    networks:
      - app-network

  # ====================================================
  # 11. NOTIFICATION SERVICE
  # ====================================================
  notification-service:
    build: ./backend/notification_service
    container_name: notification_service
    restart: unless-stopped
    environment:
      - SERVER_PORT=8080
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/j2ee_project_db?useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root123
    depends_on:
      mysql-db:
        condition: service_healthy
    networks:
      - app-network

  # ====================================================
  # 12. FRONTEND (React)
  # ====================================================
  frontend:
    build: ./fontend   # Lưu ý: folder của bạn tên là 'fontend' (thiếu chữ r)
    container_name: frontend
    restart: unless-stopped
    ports:
      - "80:80"
    networks:
      - app-network

volumes:
  mysql-data:

networks:
  app-network:
    driver: bridge